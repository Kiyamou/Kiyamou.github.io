
<!DOCTYPE html>
<html lang="en">
    
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="308实验室">
    <title>nnedi3 相关代码学习 - 308实验室</title>
    <meta name="author" content="Kiyamou">
    
    
    
    <script type="application/ld+json">{"@context":"http://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Kiyamou","sameAs":["https://github.com/Kiyamou","https://www.kaggle.com/kiyamou"],"image":"pic.webp"},"articleBody":"引言其实不知道有没有必要像这样，为并不是很复杂的源码煞有介事地写一份包含个人感想的阅读笔记。但不得不说，nnedi3 相关的内容，从我最开始接触图像处理，就一直萦绕在心头。一直觉得 nnedi3 很神奇，抗锯齿用它，重采样放大也用它，因为用了神经网络更显得高大上。另一方面，随着 Deep Learning 浪潮涌起，有些人开始质疑对 Deep Learning 的跟风。于是有种错觉，用传统神经网络的 nnedi3，既套上了光环，又躲过了质疑。\n起初接触 nnedi3 是通过 nnedi3_resize16 这个流传甚广的缩放脚本。之后在我学会 deband 与边缘检测后，很长时间没有继续学新东西，几乎过了一年，我才接触到 nnedi3 的抗锯齿用途。又跨过大半年，在我熟悉 Github 之后，到第二年的秋天，我又看到了优化版的 znedi3 和 nnedi3cl。某种角度上，nnedi3 贯穿了我到目前为止的图像处理学习过程。\n\n\n我已经忘记之前是在哪里看到，说 nnedi3 没有开源。我也模糊得记得，找过 eedi 系列滤镜，没找到代码（事实上也是开源的）。于是交错的印象下，在我开始写 C++ 之前，没有再深入了解 nnedi3。即使是之后开始写 VapourSynth Plugin，也是模仿着 Deblock 和 nnedi2 的框架（话说这对初学者而言，和 nnedi3 比也没什么区别喂喂，只是我当时选择性地无视了）。\nBTW，学习代码不是自己写代码，有时候需要不求甚解，明白意思即可，不然也只是浪费时间。\n代码概览代码框架VapourSynth-NNEDI3CL 是 VapourSynth 框架下进行了 OpenCL 优化的 nnedi3 实现，除了 OpenCL 配置文件外，只有一份 nnedi3cl.cpp，代码结构也不复杂，VapourSynth Plugin 框架的四个函数 + 一个 process() 性质的函数。\n重新审视一下 VapourSynth Plugin 框架的四个函数，初始化函数 Init() 和 释放内存函数 Free() 不必多说，从计算内容的角度看，GetFrame() 函数是与图像内容相关的计算，会用到像素点的数据，而 Create() 函数（除获取参数外）则是无关像素点数值的计算，至多会用到视频格式的信息。从两个函数的名字上看也能看出这一点。\nNNEDI3CL 因为涉及 OpenCL，且参数较多，Create() 函数中报错信息占了较长的篇幅。nnedi3 最原始的用途是隔行插值反交错，所以在 GetFrame() 函数中，比只处理逐行的滤镜，多了 field / 场信息的判断。\n大致浏览完这些信息，核心处理从nnedi3_weights.bin文件入手。\n主要数据12345compute::command_queue queue;compute::kernel kernel;compute::image2d src, dst, tmp;compute::buffer weights0, weights1Buffer;cl_mem weights1;\n\n其中queue、kernel用于 OpenCL 框架，三个image2D类型的变量src、dst、tmp用于储存图像，余下三个变量则是与神经网络权值相关。\n在 Create() 函数内，weights0、weights1都是float指针。\ncl_mem类型用于在设备上分配内存，cl_mem类型是”Memory Object“的句柄，提供了一种内存抽象。\n神经网络IO 部分由于使用传统神经网络，需要读入权值文件nnedi3_weights.bin。IO 部分基于头文件&lt;cstdio&gt;。\n除了常见的std::fopen、std::fclose外，还用到了下面这些函数。\nstd::fread-std::size_t fread(void* buffer, std::size_t size, std::size_t count, std::FILE* stream)：从输入流读取至多 count 个对象到数组 buffer 中，返回成功读取的对象数。\nstd::rewind-void rewind(std::FILE* stream)：移动文件位置指示器到给定文件流的起始。\nstd::ftell-long ftell(std::FILE* stream)：返回文件流文件位置指示器的当前值。\n读入的权值数据保存在bdata中。\n1234constexpr long correctSize = 13574928; // Version 0.9.4 of the Avisynth pluginfloat * bdata = reinterpret_cast&lt;float *&gt;(malloc(correctSize));const size_t bytesRead = std::fread(bdata, 1, correctSize, weightsFile);\n\n权值计算的后续Create() 部分的权值有点复杂，先看看 Create() 权值计算结果是怎么用到 GetFrame() 上的吧。\n如后文的”OpenCL 变量“部分所说，三个权值变量被 GetFrame() 调用的只有两个，weights0和weights1，被调用的位置和次数一样，只是weights1在 Free() 函数中多了一步释放。\n1clReleaseMemObject(d-&gt;weights1);\n\n两个变量在三个分支的if-else中同时出现了四次，伪代码如下。\n1234567891011121314# bool d-&gt;dw, d-&gt;dh;if (d-&gt;dw &amp;&amp; d-&gt;dh)&#123;    kernel.set_args(src, tmp, d-&gt;weights0, d-&gt;weights1, size_h_w, field, -1);    kernel.set_args(tmp, dst, d-&gt;weights0, d-&gt;weights1, size_w_h, field,  0);else if (d-&gt;dw)&#123;    kernel.set_args(src, dst, d-&gt;weights0, d-&gt;weights1, size_h_w, field, -1);&#125;else&#123;    kernel.set_args(src, dst, d-&gt;weights0, d-&gt;weights1, size_w_h, field,  0);&#125;\n\n很明显，是从 x，y 两个方向分别处理。在这四次调用中，weights0和weights1发挥的作用是等价。\n进而来整体看下 GetFrame() 函数及 process() 函数（在 NNEDI3CL 里写作 filter()），常规而且仅有骨架，上面的伪代码便是核心而唯一的操作，除此之前唯一陌生的地方就是增加了 field 信息的判断。\n于是，可以转向 .cl 文件看核心计算了。\nOpenCL 核心计算这部分是 .cl 文件中的代码学习笔记。\n命名空间（好像说法不太对..）kernel下的函数有两个重载，分别对应float类型和 uint 类型，看看其中一个。（删去了&quot;\\n&quot;）\n12345__kernel __attribute__((reqd_work_group_size(4, 16, 1)))void filter_uint(__read_only image2d_t src, __write_only image2d_t dst,                 __constant float * weights0, __read_only image1d_buffer_t weights1,                 const int srcWidth, const int srcHeight, const int dstWidth,                 const int dstHeight, const int field_n, const int off, const int swap)\n\n和前面filter()函数中的核心处理相对应。\n追踪一下weights0的传递过程。\n12float8 output = PRESCREEN((const __local float (*)[INPUT_WIDTH])&amp;input[YDIAD2M1 - 1 + localY][XDIAD2M1 - PSCRN_OFFSET + 8 * localX],                          &amp;flag, weights0);\n\n（这个PRESCREEN()是啥…）\nOpenCL 接口部分这部分是 Create() 函数中出现的 OpenCL 相关内容。\n相关函数clCreateImage123456cl_mem clCreateImage(cl_context              context,                     cl_mem_flags            flags,                     const cl_image_format  *image_format,                     const cl_image_desc    *image_desc,                     void                   *host_ptr,                     cl_int                 *errcode_ret)\n\nCreates a 1D image, 1D image buffer, 1D image array, 2D image, 2D image array or 3D image object.\n创建一维图像、一维图像 buffer、一维图像数组、二维图像、二维图像数组或者三维图像对象。\nOpenCL 变量d-&gt;weights1结构体内的weights1定义如下。\n12cl_mem mem = clCreateImage(context, 0, &amp;format, &amp;desc, nullptr, &amp;error);d-&gt;weights1 = mem;\n\n其中，mem的主要数据来自desc。\ndesc的数据，除了一些格式上的常数，一是来自dims1，一是来自权值weights1Buffer，也就是三个结构体内的数据之一。\ndims1的定义如下，都是常数计算，没有额外的东西。\n1const int dims1 = nnsTable[nns] * 2 * (xdiaTable[nsize] * ydiaTable[nsize] + 1);\n\n所以综上所述，weights1与weights1Buffer有种套娃之感，核心数据是一样的。（看一下名字啊，weights1Buffer=weights1+buffer）\nd-&gt;weights0与d-&gt;weights1Buffer结构体内的weights0与weights1Buffer定义如下。\n12345d-&gt;weights0 = compute::buffer&#123; context, std::max(dims0, dims0new) * sizeof(cl_float),    CL_MEM_READ_ONLY | CL_MEM_COPY_HOST_PTR | CL_MEM_HOST_NO_ACCESS, weights0 &#125;;d-&gt;weights1Buffer = compute::buffer&#123; context, dims1 * 2 * sizeof(cl_float),    CL_MEM_READ_ONLY | CL_MEM_COPY_HOST_PTR | CL_MEM_HOST_NO_ACCESS, weights1 &#125;;\n\n事实上，weights1Buffer的调用范围仅限于 Create()，并没有在 GetFrame() 中调用。\nCreate() 内的同名变量在 Create() 函数内，有两个临时变量性质的同名变量，定义如下。\n12float* weights0 = new float[std::max(dims0, dims0new)];float* weights1 = new float[dims1 * 2];\n\n它们在定义了d-&gt;weights0与d-&gt;weights1Buffer后被释放。\n","dateCreated":"2020-04-30T21:17:39+08:00","dateModified":"2020-05-01T15:07:42+08:00","datePublished":"2020-04-30T21:17:39+08:00","description":"引言其实不知道有没有必要像这样，为并不是很复杂的源码煞有介事地写一份包含个人感想的阅读笔记。但不得不说，nnedi3 相关的内容，从我最开始接触图像处理，就一直萦绕在心头。一直觉得 nnedi3 很神奇，抗锯齿用它，重采样放大也用它，因为用了神经网络更显得高大上。另一方面，随着 Deep Learning 浪潮涌起，有些人开始质疑对 Deep Learning 的跟风。于是有种错觉，用传统神经网络的 nnedi3，既套上了光环，又躲过了质疑。\n起初接触 nnedi3 是通过 nnedi3_resize16 这个流传甚广的缩放脚本。之后在我学会 deband 与边缘检测后，很长时间没有继续学新东西，几乎过了一年，我才接触到 nnedi3 的抗锯齿用途。又跨过大半年，在我熟悉 Github 之后，到第二年的秋天，我又看到了优化版的 znedi3 和 nnedi3cl。某种角度上，nnedi3 贯穿了我到目前为止的图像处理学习过程。","headline":"nnedi3 相关代码学习","image":[],"mainEntityOfPage":{"@type":"WebPage","@id":"http://yoursite.com/2020/04/30/nnedi3/"},"publisher":{"@type":"Organization","name":"Kiyamou","sameAs":["https://github.com/Kiyamou","https://www.kaggle.com/kiyamou"],"image":"pic.webp","logo":{"@type":"ImageObject","url":"pic.webp"}},"url":"http://yoursite.com/2020/04/30/nnedi3/","keywords":"C++, VapourSynth"}</script>
    <meta name="description" content="引言其实不知道有没有必要像这样，为并不是很复杂的源码煞有介事地写一份包含个人感想的阅读笔记。但不得不说，nnedi3 相关的内容，从我最开始接触图像处理，就一直萦绕在心头。一直觉得 nnedi3 很神奇，抗锯齿用它，重采样放大也用它，因为用了神经网络更显得高大上。另一方面，随着 Deep Learning 浪潮涌起，有些人开始质疑对 Deep Learning 的跟风。于是有种错觉，用传统神经网络">
<meta name="keywords" content="C++,VapourSynth">
<meta property="og:type" content="blog">
<meta property="og:title" content="nnedi3 相关代码学习">
<meta property="og:url" content="http:&#x2F;&#x2F;yoursite.com&#x2F;2020&#x2F;04&#x2F;30&#x2F;nnedi3&#x2F;index.html">
<meta property="og:site_name" content="308实验室">
<meta property="og:description" content="引言其实不知道有没有必要像这样，为并不是很复杂的源码煞有介事地写一份包含个人感想的阅读笔记。但不得不说，nnedi3 相关的内容，从我最开始接触图像处理，就一直萦绕在心头。一直觉得 nnedi3 很神奇，抗锯齿用它，重采样放大也用它，因为用了神经网络更显得高大上。另一方面，随着 Deep Learning 浪潮涌起，有些人开始质疑对 Deep Learning 的跟风。于是有种错觉，用传统神经网络">
<meta property="og:locale" content="en">
<meta property="og:updated_time" content="2020-05-01T07:07:42.176Z">
<meta name="twitter:card" content="summary">
    
    
        
    
    
        <meta property="og:image" content="http://yoursite.com/assets/images/pic.webp"/>
    
    
    
    
    <!--STYLES-->
    <link rel="stylesheet" href="/assets/css/style-muscuy3evvxoway8bplbynzgxr6abprhavryu510e7xqtrmyf4pesaj5rt0s.min.css">
    <!--STYLES END-->
    

    

    
        
    
</head>

    <body>
        <div id="blog">
            <!-- Define author's picture -->


    
        
            
        
    

<header id="header" data-behavior="1">
    <i id="btn-open-sidebar" class="fa fa-lg fa-bars"></i>
    <div class="header-title">
        <a
            class="header-title-link"
            href="/"
            aria-label=""
        >
            308实验室
        </a>
    </div>
    
        
            <a
                class="header-right-picture "
                href="#about"
                aria-label="Open the link: /#about"
            >
        
        
            <img class="header-picture" src="/assets/images/pic.webp" alt="Author&#39;s picture"/>
        
        </a>
    
</header>

            <!-- Define author's picture -->



        
    

<nav id="sidebar" data-behavior="1">
    <div class="sidebar-container">
        
            <div class="sidebar-profile">
                <a
                    href="/#about"
                    aria-label="Read more about the author"
                >
                    <img class="sidebar-profile-picture" src="/assets/images/pic.webp" alt="Author&#39;s picture"/>
                </a>
                <h4 class="sidebar-profile-name">Kiyamou</h4>
                
                    <h5 class="sidebar-profile-bio"></h5>
                
            </div>
        
        
            <ul class="sidebar-buttons">
            
                <li class="sidebar-button">
                    
                        <a  class="sidebar-button-link "
                             href="/"
                            
                            title="Home"
                        >
                    
                        <i class="sidebar-button-icon fa fa-home" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Home</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a  class="sidebar-button-link "
                             href="/all-categories"
                            
                            title="Categories"
                        >
                    
                        <i class="sidebar-button-icon fa fa-bookmark" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Categories</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a  class="sidebar-button-link "
                             href="/all-tags"
                            
                            title="Tags"
                        >
                    
                        <i class="sidebar-button-icon fa fa-tags" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Tags</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a  class="sidebar-button-link "
                             href="/all-archives"
                            
                            title="Archives"
                        >
                    
                        <i class="sidebar-button-icon fa fa-archive" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Archives</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a  class="sidebar-button-link "
                             href="/about"
                            
                            title="About"
                        >
                    
                        <i class="sidebar-button-icon fa fa-question" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">About</span>
                    </a>
            </li>
            
        </ul>
        
            <ul class="sidebar-buttons">
            
                <li class="sidebar-button">
                    
                        <a  class="sidebar-button-link " href="https://github.com/Kiyamou" target="_blank" rel="noopener" title="GitHub">
                    
                        <i class="sidebar-button-icon fab fa-github" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">GitHub</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a  class="sidebar-button-link " href="https://www.kaggle.com/kiyamou" target="_blank" rel="noopener" title="Kaggle">
                    
                        <i class="sidebar-button-icon fab fa-kaggle" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Kaggle</span>
                    </a>
            </li>
            
        </ul>
        
    </div>
</nav>

            
            <div id="main" data-behavior="1"
                 class="
                        hasCoverMetaIn
                        ">
                
<article class="post">
    
    
        <div class="post-header main-content-wrap text-left">
    
        <h1 class="post-title">
            nnedi3 相关代码学习
        </h1>
    
    
        <div class="post-meta">
    <time datetime="2020-04-30T21:17:39+08:00">
	
		    Apr 30, 2020
    	
    </time>
    
        <span>in </span>
        
    <a class="category-link" href="/categories/%E5%9B%BE%E5%83%8F%E5%A4%84%E7%90%86/">图像处理</a>


    
</div>

    
</div>

    
    <div class="post-content markdown">
        <div class="main-content-wrap">
            <h3 id="引言"><a href="#引言" class="headerlink" title="引言"></a>引言</h3><p>其实不知道有没有必要像这样，为并不是很复杂的源码煞有介事地写一份包含个人感想的阅读笔记。但不得不说，<a href="https://forum.doom9.org/showthread.php?t=147695" target="_blank" rel="noopener">nnedi3</a> 相关的内容，从我最开始接触图像处理，就一直萦绕在心头。一直觉得 nnedi3 很神奇，抗锯齿用它，重采样放大也用它，因为用了神经网络更显得高大上。另一方面，随着 Deep Learning 浪潮涌起，有些人开始质疑对 Deep Learning 的跟风。于是有种错觉，用传统神经网络的 nnedi3，既套上了光环，又躲过了质疑。</p>
<p>起初接触 nnedi3 是通过 <a href="https://www.nmm-hd.org/newbbs/viewtopic.php?f=7&t=1117" target="_blank" rel="noopener">nnedi3_resize16</a> 这个流传甚广的缩放脚本。之后在我学会 deband 与边缘检测后，很长时间没有继续学新东西，几乎过了一年，我才接触到 nnedi3 的抗锯齿用途。又跨过大半年，在我熟悉 Github 之后，到第二年的秋天，我又看到了优化版的 <a href="https://github.com/sekrit-twc/znedi3" target="_blank" rel="noopener">znedi3</a> 和 <a href="(https://github.com/HomeOfVapourSynthEvolution/VapourSynth-NNEDI3CL)">nnedi3cl</a>。某种角度上，nnedi3 贯穿了我到目前为止的图像处理学习过程。</p>
<a id="more"></a>

<p>我已经忘记之前是在哪里看到，说 nnedi3 没有开源。我也模糊得记得，找过 eedi 系列滤镜，没找到代码（事实上也是开源的）。于是交错的印象下，在我开始写 C++ 之前，没有再深入了解 nnedi3。即使是之后开始写 VapourSynth Plugin，也是模仿着 Deblock 和 nnedi2 的框架（话说这对初学者而言，和 nnedi3 比也没什么区别喂喂，只是我当时选择性地无视了）。</p>
<p>BTW，学习代码不是自己写代码，有时候需要不求甚解，明白意思即可，不然也只是浪费时间。</p>
<h3 id="代码概览"><a href="#代码概览" class="headerlink" title="代码概览"></a>代码概览</h3><h4 id="代码框架"><a href="#代码框架" class="headerlink" title="代码框架"></a>代码框架</h4><p><a href="https://github.com/HomeOfVapourSynthEvolution/VapourSynth-NNEDI3CL" target="_blank" rel="noopener">VapourSynth-NNEDI3CL</a> 是 VapourSynth 框架下进行了 OpenCL 优化的 nnedi3 实现，除了 OpenCL 配置文件外，只有一份 nnedi3cl.cpp，代码结构也不复杂，VapourSynth Plugin 框架的四个函数 + 一个 process() 性质的函数。</p>
<p>重新审视一下 VapourSynth Plugin 框架的四个函数，初始化函数 Init() 和 释放内存函数 Free() 不必多说，从计算内容的角度看，GetFrame() 函数是与图像内容相关的计算，会用到像素点的数据，而 Create() 函数（除获取参数外）则是无关像素点数值的计算，至多会用到视频格式的信息。从两个函数的名字上看也能看出这一点。</p>
<p>NNEDI3CL 因为涉及 OpenCL，且参数较多，Create() 函数中报错信息占了较长的篇幅。nnedi3 最原始的用途是隔行插值反交错，所以在 GetFrame() 函数中，比只处理逐行的滤镜，多了 field / 场信息的判断。</p>
<p>大致浏览完这些信息，核心处理从<code>nnedi3_weights.bin</code>文件入手。</p>
<h4 id="主要数据"><a href="#主要数据" class="headerlink" title="主要数据"></a>主要数据</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">compute::command_queue <span class="built_in">queue</span>;</span><br><span class="line">compute::kernel kernel;</span><br><span class="line">compute::image2d src, dst, tmp;</span><br><span class="line">compute::buffer weights0, weights1Buffer;</span><br><span class="line">cl_mem weights1;</span><br></pre></td></tr></table></figure>

<p>其中<code>queue</code>、<code>kernel</code>用于 OpenCL 框架，三个<code>image2D</code>类型的变量<code>src</code>、<code>dst</code>、<code>tmp</code>用于储存图像，余下三个变量则是与神经网络权值相关。</p>
<p>在 Create() 函数内，<code>weights0</code>、<code>weights1</code>都是<code>float</code>指针。</p>
<p><code>cl_mem</code>类型用于在设备上分配内存，<code>cl_mem</code>类型是”Memory Object“的句柄，提供了一种内存抽象。</p>
<h3 id="神经网络"><a href="#神经网络" class="headerlink" title="神经网络"></a>神经网络</h3><h4 id="IO-部分"><a href="#IO-部分" class="headerlink" title="IO 部分"></a>IO 部分</h4><p>由于使用传统神经网络，需要读入权值文件<code>nnedi3_weights.bin</code>。IO 部分基于头文件<code>&lt;cstdio&gt;</code>。</p>
<p>除了常见的<code>std::fopen</code>、<code>std::fclose</code>外，还用到了下面这些函数。</p>
<p><code>std::fread</code>-<code>std::size_t fread(void* buffer, std::size_t size, std::size_t count, std::FILE* stream)</code>：从输入流读取至多 <code>count</code> 个对象到数组 <code>buffer</code> 中，返回成功读取的对象数。</p>
<p><code>std::rewind</code>-<code>void rewind(std::FILE* stream)</code>：移动文件位置指示器到给定文件流的起始。</p>
<p><code>std::ftell</code>-<code>long ftell(std::FILE* stream)</code>：返回文件流文件位置指示器的当前值。</p>
<p>读入的<strong>权值数据保存在<code>bdata</code>中</strong>。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">constexpr</span> <span class="keyword">long</span> correctSize = <span class="number">13574928</span>; <span class="comment">// Version 0.9.4 of the Avisynth plugin</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">float</span> * bdata = <span class="keyword">reinterpret_cast</span>&lt;<span class="keyword">float</span> *&gt;(<span class="built_in">malloc</span>(correctSize));</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">size_t</span> bytesRead = <span class="built_in">std</span>::fread(bdata, <span class="number">1</span>, correctSize, weightsFile);</span><br></pre></td></tr></table></figure>

<h4 id="权值计算的后续"><a href="#权值计算的后续" class="headerlink" title="权值计算的后续"></a>权值计算的后续</h4><p>Create() 部分的权值有点复杂，先看看 Create() 权值计算结果是怎么用到 GetFrame() 上的吧。</p>
<p>如后文的”OpenCL 变量“部分所说，三个权值变量被 GetFrame() 调用的只有两个，<code>weights0</code>和<code>weights1</code>，被调用的位置和次数一样，只是<code>weights1</code>在 Free() 函数中多了一步释放。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">clReleaseMemObject(d-&gt;weights1);</span><br></pre></td></tr></table></figure>

<p>两个变量在三个分支的<code>if-else</code>中同时出现了四次，伪代码如下。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># bool d-&gt;dw, d-&gt;dh;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (d-&gt;dw &amp;&amp; d-&gt;dh)</span><br><span class="line">&#123;</span><br><span class="line">    kernel.set_args(src, tmp, d-&gt;weights0, d-&gt;weights1, size_h_w, field, <span class="number">-1</span>);</span><br><span class="line">    kernel.set_args(tmp, dst, d-&gt;weights0, d-&gt;weights1, size_w_h, field,  <span class="number">0</span>);</span><br><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> (d-&gt;dw)</span><br><span class="line">&#123;</span><br><span class="line">    kernel.set_args(src, dst, d-&gt;weights0, d-&gt;weights1, size_h_w, field, <span class="number">-1</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line">    kernel.set_args(src, dst, d-&gt;weights0, d-&gt;weights1, size_w_h, field,  <span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>很明显，是从 x，y 两个方向分别处理。在这四次调用中，<code>weights0</code>和<code>weights1</code>发挥的作用是等价。</p>
<p>进而来整体看下 GetFrame() 函数及 process() 函数（在 NNEDI3CL 里写作 <code>filter()</code>），常规而且仅有骨架，上面的伪代码便是核心而唯一的操作，除此之前唯一陌生的地方就是增加了 field 信息的判断。</p>
<p>于是，可以转向 .cl 文件看核心计算了。</p>
<h3 id="OpenCL-核心计算"><a href="#OpenCL-核心计算" class="headerlink" title="OpenCL 核心计算"></a>OpenCL 核心计算</h3><p>这部分是 .cl 文件中的代码学习笔记。</p>
<p>命名空间（好像说法不太对..）<code>kernel</code>下的函数有两个重载，分别对应<code>float</code>类型和 uint 类型，看看其中一个。（删去了<code>&quot;\n&quot;</code>）</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">__kernel __attribute__((reqd_work_group_size(<span class="number">4</span>, <span class="number">16</span>, <span class="number">1</span>)))</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">filter_uint</span><span class="params">(__read_only <span class="keyword">image2d_t</span> src, __write_only <span class="keyword">image2d_t</span> dst,</span></span></span><br><span class="line"><span class="function"><span class="params">                 __constant <span class="keyword">float</span> * weights0, __read_only <span class="keyword">image1d_buffer_t</span> weights1,</span></span></span><br><span class="line"><span class="function"><span class="params">                 <span class="keyword">const</span> <span class="keyword">int</span> srcWidth, <span class="keyword">const</span> <span class="keyword">int</span> srcHeight, <span class="keyword">const</span> <span class="keyword">int</span> dstWidth,</span></span></span><br><span class="line"><span class="function"><span class="params">                 <span class="keyword">const</span> <span class="keyword">int</span> dstHeight, <span class="keyword">const</span> <span class="keyword">int</span> field_n, <span class="keyword">const</span> <span class="keyword">int</span> off, <span class="keyword">const</span> <span class="keyword">int</span> swap)</span></span></span><br></pre></td></tr></table></figure>

<p>和前面<code>filter()</code>函数中的核心处理相对应。</p>
<p>追踪一下<code>weights0</code>的传递过程。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">float8 output = PRESCREEN((<span class="keyword">const</span> __local <span class="keyword">float</span> (*)[INPUT_WIDTH])&amp;input[YDIAD2M1 - <span class="number">1</span> + localY][XDIAD2M1 - PSCRN_OFFSET + <span class="number">8</span> * localX],</span><br><span class="line">                          &amp;flag, weights0);</span><br></pre></td></tr></table></figure>

<p>（这个<code>PRESCREEN()</code>是啥…）</p>
<h3 id="OpenCL-接口部分"><a href="#OpenCL-接口部分" class="headerlink" title="OpenCL 接口部分"></a>OpenCL 接口部分</h3><p>这部分是 Create() 函数中出现的 OpenCL 相关内容。</p>
<h4 id="相关函数"><a href="#相关函数" class="headerlink" title="相关函数"></a>相关函数</h4><h5 id="clCreateImage"><a href="#clCreateImage" class="headerlink" title="clCreateImage"></a><code>clCreateImage</code></h5><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">cl_mem <span class="title">clCreateImage</span><span class="params">(cl_context              context,</span></span></span><br><span class="line"><span class="function"><span class="params">                     cl_mem_flags            flags,</span></span></span><br><span class="line"><span class="function"><span class="params">                     <span class="keyword">const</span> cl_image_format  *image_format,</span></span></span><br><span class="line"><span class="function"><span class="params">                     <span class="keyword">const</span> cl_image_desc    *image_desc,</span></span></span><br><span class="line"><span class="function"><span class="params">                     <span class="keyword">void</span>                   *host_ptr,</span></span></span><br><span class="line"><span class="function"><span class="params">                     cl_int                 *errcode_ret)</span></span></span><br></pre></td></tr></table></figure>

<p>Creates a 1D image, 1D image buffer, 1D image array, 2D image, 2D image array or 3D image object.</p>
<p>创建一维图像、一维图像 buffer、一维图像数组、二维图像、二维图像数组或者三维图像对象。</p>
<h4 id="OpenCL-变量"><a href="#OpenCL-变量" class="headerlink" title="OpenCL 变量"></a>OpenCL 变量</h4><h5 id="d-gt-weights1"><a href="#d-gt-weights1" class="headerlink" title="d-&gt;weights1"></a><code>d-&gt;weights1</code></h5><p>结构体内的<code>weights1</code>定义如下。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cl_mem mem = clCreateImage(context, <span class="number">0</span>, &amp;format, &amp;desc, <span class="literal">nullptr</span>, &amp;error);</span><br><span class="line">d-&gt;weights1 = mem;</span><br></pre></td></tr></table></figure>

<p>其中，<code>mem</code>的主要数据来自<code>desc</code>。</p>
<p><code>desc</code>的数据，除了一些格式上的常数，一是来自<code>dims1</code>，一是来自权值<code>weights1Buffer</code>，也就是三个结构体内的数据之一。</p>
<p><code>dims1</code>的定义如下，都是常数计算，没有额外的东西。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> dims1 = nnsTable[nns] * <span class="number">2</span> * (xdiaTable[nsize] * ydiaTable[nsize] + <span class="number">1</span>);</span><br></pre></td></tr></table></figure>

<p>所以综上所述，<code>weights1</code>与<code>weights1Buffer</code>有种套娃之感，核心数据是一样的。（看一下名字啊，<code>weights1Buffer</code>=<code>weights1</code>+<code>buffer</code>）</p>
<h5 id="d-gt-weights0与d-gt-weights1Buffer"><a href="#d-gt-weights0与d-gt-weights1Buffer" class="headerlink" title="d-&gt;weights0与d-&gt;weights1Buffer"></a><code>d-&gt;weights0</code>与<code>d-&gt;weights1Buffer</code></h5><p>结构体内的<code>weights0</code>与<code>weights1Buffer</code>定义如下。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">d-&gt;weights0 = compute::buffer&#123; context, <span class="built_in">std</span>::max(dims0, dims0new) * <span class="keyword">sizeof</span>(cl_float),</span><br><span class="line">    CL_MEM_READ_ONLY | CL_MEM_COPY_HOST_PTR | CL_MEM_HOST_NO_ACCESS, weights0 &#125;;</span><br><span class="line"></span><br><span class="line">d-&gt;weights1Buffer = compute::buffer&#123; context, dims1 * <span class="number">2</span> * <span class="keyword">sizeof</span>(cl_float),</span><br><span class="line">    CL_MEM_READ_ONLY | CL_MEM_COPY_HOST_PTR | CL_MEM_HOST_NO_ACCESS, weights1 &#125;;</span><br></pre></td></tr></table></figure>

<p>事实上，<code>weights1Buffer</code>的调用范围仅限于 Create()，并没有在 GetFrame() 中调用。</p>
<h5 id="Create-内的同名变量"><a href="#Create-内的同名变量" class="headerlink" title="Create() 内的同名变量"></a>Create() 内的同名变量</h5><p>在 Create() 函数内，有两个临时变量性质的同名变量，定义如下。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">float</span>* weights0 = <span class="keyword">new</span> <span class="keyword">float</span>[<span class="built_in">std</span>::max(dims0, dims0new)];</span><br><span class="line"><span class="keyword">float</span>* weights1 = <span class="keyword">new</span> <span class="keyword">float</span>[dims1 * <span class="number">2</span>];</span><br></pre></td></tr></table></figure>

<p>它们在定义了<code>d-&gt;weights0</code>与<code>d-&gt;weights1Buffer</code>后被释放。</p>

            


        </div>
    </div>
    <div id="post-footer" class="post-footer main-content-wrap">
        
            <div class="post-footer-tags">
                <span class="text-color-light text-small">TAGGED IN</span><br/>
                
    <a class="tag tag--primary tag--small t-link" href="/tags/C/" rel="tag">C++</a> <a class="tag tag--primary tag--small t-link" href="/tags/VapourSynth/" rel="tag">VapourSynth</a>

            </div>
        
        
            <div class="post-actions-wrap">
    <nav>
        <ul class="post-actions post-action-nav">
            <li class="post-action">
                
                    
                <a
                    class="post-action-btn btn btn--default tooltip--top"
                    href="/2020/05/30/Dont-starve/"
                    data-tooltip="游戏《饥荒》食谱个人点评"
                    aria-label="PREVIOUS: 游戏《饥荒》食谱个人点评"
                >
                    
                        <i class="fa fa-angle-left" aria-hidden="true"></i>
                        <span class="hide-xs hide-sm text-small icon-ml">PREVIOUS</span>
                    </a>
            </li>
            <li class="post-action">
                
                    
                <a
                    class="post-action-btn btn btn--default tooltip--top"
                    href="/2020/04/28/dehazing/"
                    data-tooltip="一些较新的去雾（dehazing）算法"
                    aria-label="NEXT: 一些较新的去雾（dehazing）算法"
                >
                    
                        <span class="hide-xs hide-sm text-small icon-mr">NEXT</span>
                        <i class="fa fa-angle-right" aria-hidden="true"></i>
                    </a>
            </li>
        </ul>
    </nav>
    <ul class="post-actions post-action-share">
        <li class="post-action hide-lg hide-md hide-sm">
            <a
                class="post-action-btn btn btn--default btn-open-shareoptions"
                href="#btn-open-shareoptions"
                aria-label="Share this post"
            >
                <i class="fa fa-share-alt" aria-hidden="true"></i>
            </a>
        </li>
        
            
            
            <li class="post-action hide-xs">
                <a
                    class="post-action-btn btn btn--default"
                    target="new" href="https://www.facebook.com/sharer/sharer.php?u=http://yoursite.com/2020/04/30/nnedi3/"
                    title="Share on Facebook"
                    aria-label="Share on Facebook"
                >
                    <i class="fab fa-facebook" aria-hidden="true"></i>
                </a>
            </li>
        
            
            
            <li class="post-action hide-xs">
                <a
                    class="post-action-btn btn btn--default"
                    target="new" href="https://twitter.com/intent/tweet?text=http://yoursite.com/2020/04/30/nnedi3/"
                    title="Share on Twitter"
                    aria-label="Share on Twitter"
                >
                    <i class="fab fa-twitter" aria-hidden="true"></i>
                </a>
            </li>
        
            
            
            <li class="post-action hide-xs">
                <a
                    class="post-action-btn btn btn--default"
                    target="new" href="https://plus.google.com/share?url=http://yoursite.com/2020/04/30/nnedi3/"
                    title="Share on Google+"
                    aria-label="Share on Google+"
                >
                    <i class="fab fa-google-plus" aria-hidden="true"></i>
                </a>
            </li>
        
        
            
        
        <li class="post-action">
            
                <a class="post-action-btn btn btn--default" href="#" aria-label="Back to top">
            
                <i class="fa fa-list" aria-hidden="true"></i>
            </a>
        </li>
    </ul>
</div>


        
        
            
        
    </div>
</article>



                <footer id="footer" class="main-content-wrap">
    <span class="copyrights">
        Blog 托管于 <a href="https://pages.github.com/" target="_blank">GitHub Pages</a>.<br>
        &copy; 2019~2020 Kiyamou. 由 <a href="http://hexo.io/" target="_blank">Hexo</a> 强力驱动, Theme By <a href="https://github.com/LouisBarranqueiro/hexo-theme-tranquilpeak" target="_blank">LouisBarranqueiro</a>.
    </span>
</footer>

            </div>
            
                <div id="bottom-bar" class="post-bottom-bar" data-behavior="1">
                    <div class="post-actions-wrap">
    <nav>
        <ul class="post-actions post-action-nav">
            <li class="post-action">
                
                    
                <a
                    class="post-action-btn btn btn--default tooltip--top"
                    href="/2020/05/30/Dont-starve/"
                    data-tooltip="游戏《饥荒》食谱个人点评"
                    aria-label="PREVIOUS: 游戏《饥荒》食谱个人点评"
                >
                    
                        <i class="fa fa-angle-left" aria-hidden="true"></i>
                        <span class="hide-xs hide-sm text-small icon-ml">PREVIOUS</span>
                    </a>
            </li>
            <li class="post-action">
                
                    
                <a
                    class="post-action-btn btn btn--default tooltip--top"
                    href="/2020/04/28/dehazing/"
                    data-tooltip="一些较新的去雾（dehazing）算法"
                    aria-label="NEXT: 一些较新的去雾（dehazing）算法"
                >
                    
                        <span class="hide-xs hide-sm text-small icon-mr">NEXT</span>
                        <i class="fa fa-angle-right" aria-hidden="true"></i>
                    </a>
            </li>
        </ul>
    </nav>
    <ul class="post-actions post-action-share">
        <li class="post-action hide-lg hide-md hide-sm">
            <a
                class="post-action-btn btn btn--default btn-open-shareoptions"
                href="#btn-open-shareoptions"
                aria-label="Share this post"
            >
                <i class="fa fa-share-alt" aria-hidden="true"></i>
            </a>
        </li>
        
            
            
            <li class="post-action hide-xs">
                <a
                    class="post-action-btn btn btn--default"
                    target="new" href="https://www.facebook.com/sharer/sharer.php?u=http://yoursite.com/2020/04/30/nnedi3/"
                    title="Share on Facebook"
                    aria-label="Share on Facebook"
                >
                    <i class="fab fa-facebook" aria-hidden="true"></i>
                </a>
            </li>
        
            
            
            <li class="post-action hide-xs">
                <a
                    class="post-action-btn btn btn--default"
                    target="new" href="https://twitter.com/intent/tweet?text=http://yoursite.com/2020/04/30/nnedi3/"
                    title="Share on Twitter"
                    aria-label="Share on Twitter"
                >
                    <i class="fab fa-twitter" aria-hidden="true"></i>
                </a>
            </li>
        
            
            
            <li class="post-action hide-xs">
                <a
                    class="post-action-btn btn btn--default"
                    target="new" href="https://plus.google.com/share?url=http://yoursite.com/2020/04/30/nnedi3/"
                    title="Share on Google+"
                    aria-label="Share on Google+"
                >
                    <i class="fab fa-google-plus" aria-hidden="true"></i>
                </a>
            </li>
        
        
            
        
        <li class="post-action">
            
                <a class="post-action-btn btn btn--default" href="#" aria-label="Back to top">
            
                <i class="fa fa-list" aria-hidden="true"></i>
            </a>
        </li>
    </ul>
</div>


                </div>
                
    <div id="share-options-bar" class="share-options-bar" data-behavior="1">
        <i id="btn-close-shareoptions" class="fa fa-times"></i>
        <ul class="share-options">
            
                
                
                <li class="share-option">
                    <a
                        class="share-option-btn"
                        target="new"
                        href="https://www.facebook.com/sharer/sharer.php?u=http://yoursite.com/2020/04/30/nnedi3/"
                        aria-label="Share on Facebook"
                    >
                        <i class="fab fa-facebook" aria-hidden="true"></i><span>Share on Facebook</span>
                    </a>
                </li>
            
                
                
                <li class="share-option">
                    <a
                        class="share-option-btn"
                        target="new"
                        href="https://twitter.com/intent/tweet?text=http://yoursite.com/2020/04/30/nnedi3/"
                        aria-label="Share on Twitter"
                    >
                        <i class="fab fa-twitter" aria-hidden="true"></i><span>Share on Twitter</span>
                    </a>
                </li>
            
                
                
                <li class="share-option">
                    <a
                        class="share-option-btn"
                        target="new"
                        href="https://plus.google.com/share?url=http://yoursite.com/2020/04/30/nnedi3/"
                        aria-label="Share on Google+"
                    >
                        <i class="fab fa-google-plus" aria-hidden="true"></i><span>Share on Google+</span>
                    </a>
                </li>
            
        </ul>
    </div>


            
        </div>
        


    
        
    

<div id="about">
    <div id="about-card">
        <div id="about-btn-close">
            <i class="fa fa-times"></i>
        </div>
        
            <img id="about-card-picture" src="/assets/images/pic.webp" alt="Author&#39;s picture"/>
        
            <h4 id="about-card-name">Kiyamou</h4>
        
            <div id="about-card-bio"></div>
        
        
            <div id="about-card-job">
                <i class="fa fa-briefcase"></i>
                <br/>
                <p>Agent</p>

            </div>
        
        
            <div id="about-card-location">
                <i class="fa fa-map-marker-alt"></i>
                <br/>
                黑蜥蜴星
            </div>
        
    </div>
</div>

        
        
<div id="cover" style="background-image:url('/assets/images/bg.webp');"></div>
        <!--SCRIPTS-->
<script src="/assets/js/script-vyqdzdel4dzahtbtecbwuohfgiuhob6mspzday4clcfd3tumk9sfuq6rjfgc.min.js"></script>
<!--SCRIPTS END-->


    




    </body>
</html>
