<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> OpenCV学习笔记（1）：入门、傅里叶变换与亮度对比度调整 · 308实验室</title><meta name="description" content="OpenCV学习笔记（1）：入门、傅里叶变换与亮度对比度调整 - Kiyamou"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="http://yoursite.com/atom.xml" title="308实验室"><meta name="generator" content="Hexo 4.2.1"><link rel="alternate" href="/atom.xml" title="308实验室" type="application/atom+xml">
</head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/circle.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="https://github.com/Kiyamou" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/about" target="_self" class="nav-list-link">ABOUT</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">OpenCV学习笔记（1）：入门、傅里叶变换与亮度对比度调整</h1><div class="post-info">Dec 27, 2019</div><div class="post-content"><script type="text/javascript"
   src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>

<p>记录一下学习《OpenCV3编程入门》的过程。由于有图像处理的基础，感觉很多内容都很亲切。</p>
<h3 id="这几天学习的总结"><a href="#这几天学习的总结" class="headerlink" title="这几天学习的总结"></a>这几天学习的总结</h3><ul>
<li>OpenCV在VS下的配置，OpenCV头文件的引用关系（第一章）</li>
<li>OpenCV基础的操作（感受到变量是怎样在函数中传递的）（第一章）</li>
<li>OpenCV的常用函数（第三章）</li>
<li>Mat矩阵变量的初始化和输出（第四章）</li>
<li>一些C++相关的基础知识（第二章）<ul>
<li><code>printf()</code>格式输出函数</li>
<li>一些变量的命名规范</li>
<li>通过宏来定义的常量，通常所有字母集体大写</li>
</ul>
</li>
<li>图像混合、亮度与对比度调整、傅里叶变换（第五章）（顺带复习了第四章的基础函数，<code>Rect()</code>、<code>Scalar()</code>、<code>Szie()</code>等）</li>
<li>窗口程序相关：滑动条的创建（第三章与第五章）</li>
</ul>
<a id="more"></a>

<p>《OpenCV3编程入门》这本书一个特点就是前后知识会有相关和重合，这样学起来感觉不错。</p>
<h3 id="傅里叶变换"><a href="#傅里叶变换" class="headerlink" title="傅里叶变换"></a>傅里叶变换</h3><p>有个之前接触过，但没有亲自操作过的概念，对数尺度缩放。</p>
<p>单纯对二维图像进行傅里叶变换，变换结果通常不容易观察，明亮的高频区域过小。为便于观察，可以进行对数缩放。</p>
<p>对数缩放在大二的课上没有讲过，但我在一个小工具里用过，比直接变换“美观”很多。</p>
<p>先回忆一下大二课堂上用matlab做过的傅里叶变换。</p>
<figure class="highlight matlab"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[Image, map] = imread(<span class="string">'C:/code/test.png'</span>, <span class="string">'png'</span>);</span><br><span class="line">imshow(Image);</span><br><span class="line"></span><br><span class="line">Image = rgb2gray(Image);    <span class="comment">% 转换为灰度图像</span></span><br><span class="line">fftI = fft2(Image);         <span class="comment">% 进行傅里叶变化</span></span><br><span class="line">sfftI = fftshift(fftI);     <span class="comment">% 将频谱中心移至图像中心</span></span><br><span class="line">RR = <span class="built_in">real</span>(sfftI);</span><br><span class="line">II = <span class="built_in">imag</span>(sfftI);</span><br><span class="line">A = <span class="built_in">sqrt</span>(RR.^<span class="number">2</span> + II.^<span class="number">2</span>);    <span class="comment">% 计算频谱幅值</span></span><br><span class="line">A = (A - <span class="built_in">min</span>(<span class="built_in">min</span>(A))) / (<span class="built_in">max</span>(<span class="built_in">max</span>(A)) - <span class="built_in">min</span>(<span class="built_in">min</span>(A))) * <span class="number">225</span>;  <span class="comment">% 归一化</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">figure</span>;</span><br><span class="line">imshow(A);</span><br><span class="line">axis square;                <span class="comment">% 将频谱图调整为正方形</span></span><br></pre></td></tr></table></figure>

<p>再重温一下用OpenCV在C++中的实现。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;opencv2/core/core.hpp&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;opencv2/imgproc/imgproc.hpp&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;opencv2/highgui/highgui.hpp&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> cv;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    Mat srcImage = imread(<span class="string">"C:/code/test.png"</span>, <span class="number">0</span>); <span class="comment">// 和matlab相似，但路径要用双引号</span></span><br><span class="line">    imshow(<span class="string">"Original Image"</span>, srcImage);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> m = getOptimalDFTSize(srcImage.rows);     <span class="comment">// 扩充边界（不知道matlab是如何处理的）</span></span><br><span class="line">    <span class="keyword">int</span> n = getOptimalDFTSize(srcImage.cols);     <span class="comment">// OpenCV的函数果然丰富，专门为DFT扩充边界的都有</span></span><br><span class="line">    Mat padded;</span><br><span class="line">    copyMakeBorder(srcImage, padded, <span class="number">0</span>, m - srcImage.rows, <span class="number">0</span>, n - srcImage.cols,</span><br><span class="line">        BORDER_CONSTANT, Scalar::all(<span class="number">0</span>));         <span class="comment">// BORDER_CONSTANT = 0</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 为傅里叶变换结果分配储存空间——这是C++作为程序语言与matlab的不同之处</span></span><br><span class="line">    Mat planes[] = &#123; Mat_&lt;<span class="keyword">float</span>&gt;(padded),</span><br><span class="line">                    Mat::zeros(padded.size(), CV_32F) &#125;; <span class="comment">// 另创建一个与padded同样大小的空矩阵</span></span><br><span class="line">    Mat complexI;</span><br><span class="line">    merge(planes, <span class="number">2</span>, complexI);   <span class="comment">// 增加一个通道，将两个planes合并，为了存储复数</span></span><br><span class="line"></span><br><span class="line">    dft(complexI, complexI);      <span class="comment">// 进行傅里叶变换</span></span><br><span class="line"></span><br><span class="line">    split(complexI, planes);</span><br><span class="line">    magnitude(planes[<span class="number">0</span>], planes[<span class="number">1</span>], planes[<span class="number">0</span>]);  <span class="comment">// 计算复数幅值，并将结果储存到planes[0]</span></span><br><span class="line">    <span class="comment">// CV_EXPORTS_W void magnitude(InputArray x, InputArray y, OutputArray magnitude);</span></span><br><span class="line">    Mat magnitudeImage = planes[<span class="number">0</span>];</span><br><span class="line"></span><br><span class="line">    magnitudeImage += Scalar::all(<span class="number">1</span>);    <span class="comment">// M = log(1 + M)</span></span><br><span class="line">    <span class="built_in">log</span>(magnitudeImage, magnitudeImage); <span class="comment">// 结果也储存在magnitudeImage中</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 若有奇数行、列，则进行裁剪（matlab里没做这步）</span></span><br><span class="line">    magnitudeImage = magnitudeImage(Rect(<span class="number">0</span>, <span class="number">0</span>, magnitudeImage.cols &amp; <span class="number">-2</span>, magnitudeImage.rows &amp; <span class="number">-2</span>));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 将频谱中心移至图像中心，显然比matlab要繁琐很多</span></span><br><span class="line">    <span class="keyword">int</span> cx = magnitudeImage.cols / <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">int</span> cy = magnitudeImage.rows / <span class="number">2</span>;</span><br><span class="line">    <span class="function">Mat <span class="title">q0</span><span class="params">(magnitudeImage, Rect(<span class="number">0</span>, <span class="number">0</span>, cx, cy))</span></span>;   <span class="comment">// 左上</span></span><br><span class="line">    <span class="function">Mat <span class="title">q1</span><span class="params">(magnitudeImage, Rect(cx, <span class="number">0</span>, cx, cy))</span></span>;  <span class="comment">// 右上</span></span><br><span class="line">    <span class="function">Mat <span class="title">q2</span><span class="params">(magnitudeImage, Rect(<span class="number">0</span>, cy, cx, cy))</span></span>;  <span class="comment">// 左下</span></span><br><span class="line">    <span class="function">Mat <span class="title">q3</span><span class="params">(magnitudeImage, Rect(cx, cy, cx, cy))</span></span>; <span class="comment">// 右下</span></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    origin:</span></span><br><span class="line"><span class="comment">       q0 | q1</span></span><br><span class="line"><span class="comment">       q2 | q3</span></span><br><span class="line"><span class="comment">    new:</span></span><br><span class="line"><span class="comment">       q3 | q2</span></span><br><span class="line"><span class="comment">       q1 | q0</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    Mat temp;</span><br><span class="line">    q0.copyTo(temp);  <span class="comment">// q0 -&gt; temp</span></span><br><span class="line">    q3.copyTo(q0);    <span class="comment">// q3 -&gt; q0</span></span><br><span class="line">    temp.copyTo(q3);  <span class="comment">// temp -&gt; q3  // 这种写法就很“面向对象”了，和之前写脚本语言的路数完全一样</span></span><br><span class="line">    q1.copyTo(temp);</span><br><span class="line">    q2.copyTo(q1);</span><br><span class="line">    temp.copyTo(q2);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 归一化</span></span><br><span class="line">    normalize(magnitudeImage, magnitudeImage, <span class="number">0</span>, <span class="number">1</span>, NORM_MINMAX);  <span class="comment">// NORM_MINMAX = 32</span></span><br><span class="line"></span><br><span class="line">    imshow(<span class="string">"DFT Image"</span>, magnitudeImage);</span><br><span class="line">    waitKey(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在一开始，把交换坐标象限的代码写成了这个样子</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Mat temp;</span><br><span class="line">q0.copyTo(temp);</span><br><span class="line">q3.copyTo(q0);</span><br><span class="line">q0.copyTo(q3);</span><br><span class="line">q1.copyTo(temp);</span><br><span class="line">q2.copyTo(q1);</span><br><span class="line">q1.copyTo(q2);</span><br></pre></td></tr></table></figure>

<p>这样的结果为</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">origin:</span></span><br><span class="line"><span class="comment">   q0 | q1</span></span><br><span class="line"><span class="comment">   q2 | q3</span></span><br><span class="line"><span class="comment">new:</span></span><br><span class="line"><span class="comment">   q3 | q2</span></span><br><span class="line"><span class="comment">   q2 | q3</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<h3 id="亮度对比度调整"><a href="#亮度对比度调整" class="headerlink" title="亮度对比度调整"></a>亮度对比度调整</h3><p>亮度、对比度调整在PS中倒是经常用，但是在之前写代码的时候，也就是调一下亮度，为了让边缘检测适应亮场、暗场。</p>
<p>作为点操作（仅通过输入图像的像素值便可计算相应输出图像的像素值），亮度和对比度之所以成对出现，因为可以写在同一个变换公式中</p>
<p>$$g(i,j) = a*(i,j) + b$$</p>
<p>其中，<code>a</code>用来控制对比度，<code>b</code>用来控制亮度。</p>
<p>具体代码如下</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;opencv2/core/core.hpp&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;opencv2/highgui/highgui.hpp&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> cv;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">on_ContrastAndBright</span><span class="params">(<span class="keyword">int</span>, <span class="keyword">void</span>*)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> g_nContrastValue, g_nBrightValue;</span><br><span class="line">Mat g_srcImage, g_dstImage;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    g_srcImage = imread(<span class="string">"C:/code/test.png"</span>);</span><br><span class="line">    g_dstImage = Mat::zeros(g_srcImage.size(), g_srcImage.type());</span><br><span class="line"></span><br><span class="line">    g_nContrastValue = <span class="number">80</span>;</span><br><span class="line">    g_nBrightValue = <span class="number">80</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 创建结果窗口</span></span><br><span class="line">    namedWindow(<span class="string">"效果图窗口"</span>, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    createTrackbar(<span class="string">"对比度： "</span>, <span class="string">"效果图窗口"</span>, &amp;g_nContrastValue, <span class="number">300</span>, on_ContrastAndBright);</span><br><span class="line">    createTrackbar(<span class="string">"亮度： "</span>, <span class="string">"效果图窗口"</span>, &amp;g_nBrightValue, <span class="number">200</span>, on_ContrastAndBright);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 函数初始化</span></span><br><span class="line">    on_ContrastAndBright(g_nContrastValue, <span class="number">0</span>);</span><br><span class="line">    on_ContrastAndBright(g_nBrightValue, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 输入q时退出程序</span></span><br><span class="line">    <span class="keyword">while</span> (<span class="keyword">char</span>(waitKey(<span class="number">1</span>) != <span class="string">'q'</span>)) &#123;&#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">on_ContrastAndBright</span><span class="params">(<span class="keyword">int</span>, <span class="keyword">void</span>*)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    namedWindow(<span class="string">"原始图窗口"</span>, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> y = <span class="number">0</span>; y &lt; g_srcImage.rows; y++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> x = <span class="number">0</span>; x &lt; g_srcImage.cols; x++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> planes = <span class="number">0</span>; planes &lt; <span class="number">3</span>; planes++)</span><br><span class="line">            &#123;</span><br><span class="line">                g_dstImage.at&lt;Vec3b&gt;(y, x)[planes] = saturate_cast&lt;uchar&gt;</span><br><span class="line">                    ((g_nContrastValue * <span class="number">0.01</span>) * g_srcImage.at&lt;Vec3b&gt;(y, x)[planes] + g_nBrightValue);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    imshow(<span class="string">"原始图窗口"</span>, g_srcImage);</span><br><span class="line">    imshow(<span class="string">"效果图窗口"</span>, g_dstImage);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="结语"><a href="#结语" class="headerlink" title="结语"></a>结语</h3><p>OpenCV与VapourSynth比较，虽然VapourSynth为处理视频提供了（面向视频的）高级API，但毕竟没有像OpenCV那样提供丰富的“半成品”函数，像扩充图像边界这样的操作要自己去写，反而体验到一些偏“底层”的东西。</p>
<p>顺带一提，刚刚会用了VS的“转到定义”功能，确实好方便。</p>
</div></article></div></main><footer><div class="paginator"><a href="/2019/12/28/ported-to-vs/" class="prev">PREV</a><a href="/2019/12/27/Phase-trans-to-vs/" class="next">NEXT</a></div><div class="copyright"><p>© 2019 - 2021 <a href="http://yoursite.com">Kiyamou</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script></body></html>